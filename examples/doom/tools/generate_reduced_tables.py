#!/usr/bin/env python3
"""
Generate reduced trig tables (1/4 size) for DOOM JavaCard port.

Takes every 4th value from the original tables and recompresses using
the same anchor+delta scheme with proportionally fewer entries.
"""

import math

# =============================================================================
# Original compressed table data (copied from tables.h)
# =============================================================================

FINETANGENT_ANCHORS = [
    -170910304,
    -34178904,
    -18988036,
    -13145455,
    -10052327,
    -8137527,
    -6835455,
    -5892567,
    -5178251,
    -4618375,
    -4167737,
    -3797206,
    -3487165,
    -3223918,
    -2997613,
    -2800983,
    -2628549,
    -2476104,
    -2340362,
    -2218719,
    -2109087,
    -2009771,
    -1919378,
    -1836758,
    -1760956,
    -1691149,
    -1626658,
    -1566898,
    -1511367,
    -1459630,
    -1411312,
    -1366084,
    -1323658,
    -1283783,
    -1246234,
    -1210813,
    -1177345,
    -1145673,
    -1115654,
    -1087164,
    -1060087,
    -1034322,
    -1009774,
    -986361,
    -964003,
    -942633,
    -922186,
    -902602,
    -883829,
    -865817,
    -848520,
    -831898,
    -815910,
    -800521,
    -785699,
    -771411,
    -757631,
    -744331,
    -731486,
    -719074,
    -707072,
    -695462,
    -684223,
    -673338,
    -662792,
    -652568,
    -642651,
    -633028,
    -623686,
    -614613,
    -605798,
    -597229,
    -588896,
    -580789,
    -572901,
    -565221,
    -557741,
    -550455,
    -543354,
    -536431,
    -529680,
    -523094,
    -516667,
    -510394,
    -504269,
    -498287,
    -492443,
    -486732,
    -481150,
    -475692,
    -470355,
    -465133,
    -460024,
    -455024,
    -450129,
    -445337,
    -440643,
    -436045,
    -431540,
    -427125,
    -422798,
    -418555,
    -414395,
    -410314,
    -406311,
    -402384,
    -398530,
    -394747,
    -391034,
    -387387,
    -383807,
    -380290,
    -376835,
    -373440,
    -370105,
    -366826,
    -363604,
    -360436,
    -357321,
    -354257,
    -351244,
    -348280,
    -345364,
    -342495,
    -339671,
    -336892,
    -334157,
    -331464,
    -328812,
    -318601,
    -308983,
    -299904,
    -291322,
    -283195,
    -275489,
    -268169,
    -261209,
    -254581,
    -248261,
    -242228,
    -236463,
    -230948,
    -225666,
    -220603,
    -215745,
    -211079,
    -206594,
    -202279,
    -198125,
    -194122,
    -190261,
    -186536,
    -182939,
    -179463,
    -176102,
    -172850,
    -169701,
    -166651,
    -163695,
    -160828,
    -158046,
    -155345,
    -152722,
    -150172,
    -147693,
    -145282,
    -142936,
    -140651,
    -138426,
    -136258,
    -134145,
    -132084,
    -130073,
    -128111,
    -126195,
    -124324,
    -122496,
    -120709,
    -118963,
    -117254,
    -115583,
    -113948,
    -112347,
    -110780,
    -109245,
    -107741,
    -106266,
    -104821,
    -103404,
    -102015,
    -100651,
    -99313,
    -98000,
    -96710,
    -95444,
    -94200,
    -92978,
    -91777,
    -90596,
    -89435,
    -88294,
    -87171,
    -86066,
    -84980,
    -83910,
    -82857,
    -81820,
    -80799,
    -79793,
    -78802,
    -77826,
    -76864,
    -75915,
    -74980,
    -74058,
    -73149,
    -72252,
    -71367,
    -70494,
    -69632,
    -68781,
    -67942,
    -67113,
    -66294,
    -65485,
    -62347,
    -59352,
    -56487,
    -53741,
    -51104,
    -48565,
    -46118,
    -43753,
    -41465,
    -39246,
    -37092,
    -34997,
    -32956,
    -30965,
    -29020,
    -27116,
    -25251,
    -23420,
    -21622,
    -19852,
    -18109,
    -16389,
    -14690,
    -13009,
    -11345,
    -9695,
    -8057,
    -6429,
    -4808,
    -3194,
    -1583,
]

FINETANGENT_AVG_DELTAS = [
    113944552,
    9765588,
    3452437,
    1752772,
    1058178,
    707647,
    506365,
    380199,
    295933,
    236873,
    193882,
    161616,
    136784,
    117267,
    101647,
    88953,
    78497,
    69782,
    62443,
    56203,
    50854,
    46235,
    42217,
    38695,
    35608,
    32871,
    30438,
    28266,
    26318,
    24565,
    22982,
    21547,
    20242,
    19053,
    17965,
    16967,
    16051,
    15208,
    14429,
    13709,
    13041,
    12421,
    11843,
    11307,
    10804,
    10335,
    9897,
    9485,
    9099,
    8736,
    8393,
    8071,
    7767,
    7480,
    7209,
    6951,
    6709,
    6478,
    6259,
    6051,
    5853,
    5665,
    5486,
    5314,
    5152,
    4996,
    4848,
    4705,
    4569,
    4439,
    4315,
    4196,
    4081,
    3971,
    3866,
    3765,
    3667,
    3574,
    3484,
    3397,
    3314,
    3233,
    3155,
    3081,
    3008,
    2939,
    2872,
    2807,
    2744,
    2683,
    2625,
    2568,
    2513,
    2460,
    2409,
    2359,
    2311,
    2264,
    2219,
    2174,
    2132,
    2090,
    2051,
    2011,
    1973,
    1936,
    1900,
    1865,
    1832,
    1798,
    1767,
    1735,
    1705,
    1675,
    1646,
    1618,
    1591,
    1564,
    1538,
    1513,
    1488,
    1464,
    1440,
    1417,
    1395,
    1373,
    1352,
    1331,
    1281,
    1206,
    1138,
    1076,
    1019,
    966,
    917,
    872,
    831,
    792,
    756,
    722,
    691,
    662,
    634,
    608,
    584,
    562,
    540,
    520,
    501,
    483,
    466,
    450,
    435,
    421,
    407,
    394,
    382,
    370,
    359,
    348,
    338,
    328,
    319,
    310,
    301,
    293,
    286,
    278,
    271,
    264,
    258,
    251,
    245,
    239,
    234,
    228,
    223,
    218,
    213,
    209,
    204,
    200,
    196,
    192,
    188,
    184,
    180,
    177,
    173,
    170,
    167,
    164,
    161,
    158,
    155,
    153,
    150,
    147,
    145,
    142,
    140,
    138,
    136,
    133,
    131,
    129,
    127,
    125,
    124,
    122,
    120,
    118,
    117,
    115,
    113,
    112,
    110,
    109,
    107,
    106,
    105,
    103,
    102,
    101,
    98,
    93,
    89,
    85,
    82,
    79,
    76,
    73,
    71,
    69,
    67,
    65,
    63,
    62,
    60,
    59,
    58,
    57,
    56,
    55,
    54,
    53,
    53,
    52,
    52,
    51,
    51,
    50,
    50,
    50,
    50,
    50,
]

FINETANGENT_OFFSETS = [
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    29,
    49,
    59,
    59,
    49,
    29,
    1,
    27,
    46,
    55,
    56,
    47,
    30,
    5,
    26,
    43,
    52,
    52,
    45,
    29,
    6,
    23,
    38,
    46,
    46,
    39,
    25,
    3,
    21,
    35,
    42,
    42,
    35,
    22,
    1,
    19,
    32,
    39,
    39,
    33,
    21,
    3,
    19,
    31,
    38,
    39,
    33,
    22,
    6,
    17,
    28,
    34,
    35,
    30,
    20,
    5,
    15,
    25,
    30,
    30,
    25,
    15,
    0,
    15,
    24,
    29,
    29,
    25,
    16,
    2,
    13,
    22,
    27,
    27,
    23,
    14,
    2,
    13,
    21,
    26,
    26,
    23,
    15,
    4,
    11,
    19,
    23,
    23,
    20,
    13,
    2,
    11,
    18,
    21,
    21,
    17,
    10,
    0,
    10,
    17,
    21,
    22,
    19,
    13,
    3,
    10,
    17,
    21,
    22,
    19,
    14,
    6,
    10,
    16,
    20,
    20,
    18,
    13,
    5,
    8,
    14,
    17,
    16,
    14,
    8,
    0,
    9,
    14,
    18,
    18,
    16,
    12,
    5,
    8,
    13,
    16,
    17,
    15,
    10,
    3,
    8,
    13,
    16,
    16,
    14,
    10,
    4,
    8,
    13,
    15,
    16,
    14,
    11,
    5,
    6,
    11,
    14,
    15,
    13,
    10,
    4,
    6,
    11,
    13,
    14,
    12,
    9,
    4,
    6,
    10,
    12,
    13,
    11,
    8,
    3,
    5,
    9,
    10,
    10,
    9,
    5,
    0,
    5,
    9,
    11,
    11,
    10,
    7,
    2,
    5,
    9,
    11,
    11,
    10,
    7,
    3,
    4,
    7,
    9,
    9,
    7,
    4,
    0,
    4,
    7,
    9,
    9,
    8,
    5,
    1,
    4,
    7,
    8,
    8,
    7,
    4,
    0,
    4,
    7,
    9,
    9,
    9,
    6,
    3,
    4,
    7,
    8,
    8,
    7,
    5,
    2,
    4,
    7,
    9,
    9,
    8,
    7,
    4,
    4,
    7,
    8,
    8,
    7,
    5,
    2,
    3,
    6,
    7,
    8,
    7,
    5,
    2,
    4,
    7,
    8,
    9,
    9,
    8,
    6,
    3,
    6,
    8,
    9,
    9,
    7,
    5,
    3,
    5,
    6,
    6,
    5,
    3,
    0,
    3,
    5,
    7,
    7,
    7,
    6,
    4,
    3,
    5,
    6,
    7,
    6,
    5,
    3,
    3,
    5,
    7,
    7,
    7,
    6,
    4,
    3,
    4,
    5,
    5,
    4,
    3,
    0,
    3,
    6,
    7,
    8,
    8,
    7,
    5,
    3,
    5,
    6,
    7,
    7,
    6,
    5,
    3,
    6,
    7,
    8,
    8,
    8,
    6,
    2,
    4,
    5,
    5,
    5,
    4,
    2,
    3,
    5,
    7,
    8,
    8,
    7,
    6,
    3,
    5,
    6,
    7,
    7,
    6,
    5,
    2,
    4,
    5,
    6,
    6,
    5,
    4,
    3,
    5,
    6,
    7,
    7,
    7,
    6,
    1,
    3,
    4,
    4,
    3,
    2,
    1,
    2,
    4,
    5,
    6,
    6,
    5,
    4,
    2,
    3,
    4,
    5,
    4,
    4,
    2,
    1,
    3,
    3,
    3,
    3,
    2,
    1,
    2,
    3,
    4,
    4,
    3,
    2,
    1,
    2,
    3,
    4,
    4,
    4,
    3,
    2,
    2,
    4,
    5,
    5,
    5,
    5,
    4,
    2,
    4,
    5,
    6,
    6,
    6,
    6,
    1,
    2,
    3,
    4,
    3,
    3,
    2,
    2,
    4,
    5,
    6,
    6,
    6,
    6,
    2,
    4,
    5,
    5,
    6,
    5,
    5,
    2,
    3,
    4,
    4,
    4,
    4,
    3,
    1,
    3,
    3,
    4,
    4,
    3,
    2,
    2,
    3,
    4,
    4,
    4,
    4,
    3,
    1,
    3,
    3,
    4,
    4,
    4,
    3,
    2,
    3,
    4,
    5,
    5,
    5,
    5,
    1,
    2,
    2,
    2,
    1,
    1,
    0,
    2,
    3,
    3,
    3,
    3,
    3,
    2,
    2,
    3,
    4,
    5,
    6,
    6,
    6,
    1,
    2,
    3,
    3,
    3,
    2,
    2,
    1,
    3,
    4,
    5,
    5,
    6,
    6,
    2,
    3,
    3,
    4,
    4,
    4,
    4,
    1,
    2,
    2,
    3,
    2,
    2,
    1,
    0,
    1,
    1,
    1,
    1,
    0,
    0,
    2,
    4,
    5,
    5,
    6,
    6,
    6,
    2,
    3,
    4,
    5,
    5,
    6,
    6,
    2,
    3,
    4,
    5,
    5,
    5,
    5,
    2,
    3,
    4,
    5,
    5,
    5,
    6,
    2,
    3,
    4,
    5,
    6,
    6,
    6,
    1,
    1,
    1,
    1,
    1,
    1,
    0,
    1,
    1,
    2,
    2,
    2,
    2,
    1,
    1,
    2,
    3,
    3,
    3,
    3,
    3,
    2,
    3,
    4,
    4,
    5,
    5,
    5,
    1,
    1,
    1,
    1,
    1,
    0,
    0,
    1,
    2,
    2,
    3,
    3,
    3,
    3,
    1,
    3,
    4,
    4,
    5,
    5,
    5,
    1,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    3,
    4,
    4,
    5,
    5,
    5,
    1,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    3,
    4,
    5,
    5,
    6,
    6,
    1,
    2,
    2,
    3,
    3,
    3,
    3,
    0,
    1,
    1,
    1,
    1,
    0,
    0,
    2,
    3,
    4,
    4,
    5,
    5,
    5,
    1,
    2,
    3,
    3,
    3,
    3,
    3,
    1,
    1,
    2,
    2,
    2,
    2,
    1,
    2,
    4,
    6,
    8,
    10,
    12,
    13,
    14,
    16,
    17,
    18,
    18,
    19,
    19,
    19,
    20,
    20,
    19,
    19,
    19,
    18,
    17,
    16,
    15,
    14,
    13,
    11,
    10,
    8,
    6,
    4,
    3,
    5,
    8,
    10,
    12,
    14,
    16,
    18,
    19,
    21,
    22,
    23,
    24,
    25,
    26,
    26,
    27,
    27,
    28,
    28,
    28,
    28,
    27,
    27,
    26,
    26,
    25,
    24,
    23,
    22,
    20,
    2,
    5,
    7,
    9,
    11,
    13,
    14,
    16,
    17,
    19,
    20,
    21,
    22,
    23,
    23,
    24,
    24,
    25,
    25,
    25,
    25,
    25,
    24,
    24,
    23,
    23,
    22,
    21,
    20,
    19,
    18,
    2,
    5,
    7,
    9,
    11,
    13,
    15,
    17,
    18,
    20,
    21,
    23,
    24,
    25,
    26,
    27,
    27,
    28,
    29,
    29,
    29,
    30,
    30,
    30,
    29,
    29,
    29,
    28,
    28,
    27,
    26,
    2,
    3,
    5,
    7,
    9,
    10,
    11,
    13,
    14,
    15,
    16,
    17,
    18,
    18,
    19,
    19,
    20,
    20,
    20,
    20,
    20,
    20,
    20,
    19,
    19,
    18,
    18,
    17,
    16,
    15,
    14,
    2,
    4,
    5,
    7,
    8,
    9,
    11,
    12,
    13,
    14,
    14,
    15,
    16,
    16,
    17,
    17,
    17,
    18,
    18,
    18,
    18,
    17,
    17,
    17,
    16,
    16,
    15,
    14,
    14,
    13,
    12,
    1,
    3,
    5,
    6,
    8,
    9,
    11,
    12,
    13,
    14,
    15,
    16,
    17,
    17,
    18,
    18,
    19,
    19,
    19,
    20,
    20,
    20,
    20,
    20,
    19,
    19,
    19,
    18,
    18,
    17,
    16,
    3,
    5,
    7,
    8,
    10,
    12,
    14,
    15,
    17,
    18,
    19,
    21,
    22,
    23,
    24,
    25,
    26,
    26,
    27,
    28,
    28,
    29,
    29,
    29,
    30,
    30,
    30,
    30,
    30,
    30,
    29,
    2,
    3,
    5,
    6,
    8,
    9,
    10,
    11,
    12,
    13,
    14,
    15,
    16,
    16,
    17,
    17,
    18,
    18,
    19,
    19,
    19,
    19,
    19,
    19,
    19,
    19,
    19,
    18,
    18,
    18,
    17,
    2,
    3,
    4,
    5,
    7,
    8,
    9,
    9,
    10,
    11,
    12,
    12,
    13,
    13,
    14,
    14,
    14,
    15,
    15,
    15,
    15,
    15,
    15,
    15,
    14,
    14,
    14,
    13,
    13,
    12,
    12,
    1,
    2,
    3,
    5,
    6,
    7,
    7,
    8,
    9,
    10,
    10,
    11,
    11,
    12,
    12,
    13,
    13,
    13,
    13,
    13,
    13,
    13,
    13,
    13,
    13,
    13,
    12,
    12,
    12,
    11,
    11,
    1,
    3,
    4,
    5,
    6,
    7,
    8,
    9,
    10,
    11,
    12,
    12,
    13,
    14,
    14,
    15,
    15,
    15,
    16,
    16,
    16,
    16,
    17,
    17,
    17,
    17,
    16,
    16,
    16,
    16,
    15,
    2,
    3,
    5,
    6,
    7,
    9,
    10,
    11,
    12,
    13,
    15,
    16,
    16,
    17,
    18,
    19,
    20,
    20,
    21,
    22,
    22,
    23,
    23,
    24,
    24,
    24,
    24,
    25,
    25,
    25,
    25,
    1,
    2,
    3,
    3,
    4,
    5,
    6,
    6,
    7,
    7,
    8,
    8,
    9,
    9,
    9,
    9,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    9,
    9,
    9,
    8,
    8,
    8,
    1,
    3,
    4,
    6,
    7,
    8,
    9,
    11,
    12,
    13,
    14,
    15,
    16,
    17,
    17,
    18,
    19,
    20,
    20,
    21,
    22,
    22,
    23,
    23,
    24,
    24,
    24,
    25,
    25,
    25,
    25,
    2,
    3,
    4,
    5,
    6,
    6,
    7,
    8,
    9,
    10,
    10,
    11,
    12,
    12,
    13,
    13,
    14,
    14,
    15,
    15,
    15,
    15,
    16,
    16,
    16,
    16,
    16,
    16,
    16,
    16,
    16,
    1,
    2,
    2,
    3,
    4,
    5,
    5,
    6,
    6,
    7,
    7,
    8,
    8,
    9,
    9,
    9,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    1,
    2,
    2,
    3,
    4,
    4,
    5,
    5,
    6,
    6,
    6,
    7,
    7,
    7,
    7,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    8,
    7,
    7,
    7,
    0,
    1,
    2,
    2,
    3,
    3,
    4,
    4,
    5,
    5,
    5,
    6,
    6,
    6,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    7,
    6,
    1,
    2,
    2,
    3,
    4,
    4,
    5,
    5,
    6,
    6,
    7,
    7,
    7,
    8,
    8,
    8,
    9,
    9,
    9,
    9,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    10,
    1,
    2,
    2,
    3,
    4,
    5,
    5,
    6,
    7,
    7,
    8,
    9,
    9,
    10,
    10,
    11,
    11,
    12,
    12,
    12,
    13,
    13,
    13,
    14,
    14,
    14,
    14,
    15,
    15,
    15,
    15,
    1,
    2,
    4,
    5,
    6,
    7,
    7,
    8,
    9,
    10,
    11,
    12,
    13,
    14,
    14,
    15,
    16,
    17,
    17,
    18,
    19,
    19,
    20,
    20,
    21,
    21,
    22,
    22,
    23,
    23,
    24,
    1,
    1,
    1,
    2,
    2,
    2,
    3,
    3,
    3,
    3,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    4,
    3,
    1,
    2,
    3,
    3,
    4,
    5,
    5,
    6,
    7,
    7,
    8,
    9,
    9,
    10,
    10,
    11,
    11,
    12,
    12,
    13,
    13,
    13,
    14,
    14,
    15,
    15,
    15,
    16,
    16,
    16,
    16,
    0,
    0,
    0,
    1,
    1,
    1,
    1,
    1,
    1,
    1,
    1,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    2,
    1,
    1,
    1,
    1,
    1,
    1,
    1,
    1,
    0,
    0,
    0,
    1,
    1,
    2,
    3,
    4,
    4,
    5,
    6,
    6,
    7,
    7,
    8,
    9,
    9,
    10,
    10,
    11,
    12,
    12,
    13,
    13,
    14,
    14,
    15,
    15,
    15,
    16,
    16,
    17,
    17,
    17,
    0,
    1,
    1,
    1,
    2,
    2,
    2,
    2,
    3,
    3,
    3,
    3,
    4,
    4,
    4,
    4,
    4,
    5,
    5,
    5,
    5,
    5,
    5,
    5,
    6,
    6,
    6,
    6,
    6,
    6,
    6,
    1,
    2,
    3,
    4,
    5,
    6,
    7,
    8,
    9,
    10,
    11,
    12,
    12,
    13,
    14,
    15,
    16,
    17,
    18,
    19,
    19,
    20,
    21,
    22,
    23,
    24,
    24,
    25,
    26,
    27,
    27,
    1,
    2,
    2,
    3,
    4,
    5,
    5,
    6,
    7,
    7,
    8,
    9,
    9,
    10,
    11,
    11,
    12,
    12,
    13,
    14,
    14,
    15,
    15,
    16,
    17,
    17,
    18,
    18,
    19,
    19,
    20,
    0,
    1,
    1,
    2,
    2,
    3,
    3,
    4,
    4,
    5,
    5,
    6,
    6,
    7,
    7,
    7,
    8,
    8,
    9,
    9,
    10,
    10,
    10,
    11,
    11,
    12,
    12,
    13,
    13,
    13,
    14,
    0,
    1,
    1,
    2,
    2,
    2,
    3,
    3,
    3,
    4,
    4,
    4,
    5,
    5,
    5,
    6,
    6,
    6,
    7,
    7,
    7,
    8,
    8,
    8,
    9,
    9,
    9,
    10,
    10,
    10,
    11,
    0,
    0,
    1,
    1,
    1,
    2,
    2,
    2,
    2,
    3,
    3,
    3,
    4,
    4,
    4,
    4,
    5,
    5,
    5,
    5,
    6,
    6,
    6,
    7,
    7,
    7,
    7,
    8,
    8,
    8,
    8,
]

FINESINE_ANCHORS = [
    25,
    226,
    427,
    628,
    829,
    1030,
    1231,
    1432,
    1633,
    1834,
    2035,
    2236,
    2437,
    2638,
    2839,
    3039,
    3240,
    3441,
    3642,
    3843,
    4043,
    4244,
    4445,
    4645,
    4846,
    5046,
    5247,
    5447,
    5647,
    5848,
    6048,
    6248,
    6448,
    6648,
    6848,
    7048,
    7248,
    7448,
    7648,
    7847,
    8047,
    8246,
    8446,
    8645,
    8844,
    9043,
    9243,
    9442,
    9640,
    9839,
    10038,
    10237,
    10435,
    10634,
    10832,
    11030,
    11228,
    11426,
    11624,
    11822,
    12020,
    12218,
    12415,
    12612,
    12810,
    13007,
    13204,
    13401,
    13597,
    13794,
    13990,
    14187,
    14383,
    14579,
    14775,
    14971,
    15167,
    15362,
    15557,
    15753,
    15948,
    16143,
    16338,
    16532,
    16727,
    16921,
    17115,
    17309,
    17503,
    17697,
    17890,
    18084,
    18277,
    18470,
    18663,
    18855,
    19048,
    19240,
    19432,
    19624,
    19816,
    20007,
    20199,
    20390,
    20581,
    20772,
    20962,
    21153,
    21343,
    21533,
    21723,
    21912,
    22102,
    22291,
    22480,
    22668,
    22857,
    23045,
    23233,
    23421,
    23609,
    23796,
    23984,
    24171,
    24357,
    24544,
    24730,
    24916,
    25102,
    25288,
    25473,
    25658,
    25843,
    26028,
    26212,
    26396,
    26580,
    26764,
    26947,
    27131,
    27313,
    27496,
    27678,
    27861,
    28042,
    28224,
    28405,
    28586,
    28767,
    28948,
    29128,
    29308,
    29488,
    29667,
    29846,
    30025,
    30204,
    30382,
    30560,
    30738,
    30915,
    31092,
    31269,
    31446,
    31622,
    31798,
    31974,
    32149,
    32324,
    32499,
    32673,
    32847,
    33021,
    33195,
    33368,
    33541,
    33713,
    33886,
    34057,
    34229,
    34400,
    34571,
    34742,
    34912,
    35082,
    35252,
    35421,
    35590,
    35759,
    35927,
    36095,
    36263,
    36430,
    36597,
    36764,
    36930,
    37096,
    37262,
    37427,
    37592,
    37756,
    37920,
    38084,
    38248,
    38411,
    38573,
    38736,
    38898,
    39059,
    39221,
    39382,
    39542,
    39702,
    39862,
    40021,
    40180,
    40339,
    40497,
    40655,
    40813,
    40970,
    41127,
    41283,
    41439,
    41595,
    41750,
    41904,
    42059,
    42213,
    42366,
    42520,
    42672,
    42825,
    42977,
    43128,
    43280,
    43430,
    43581,
    43731,
    43880,
    44029,
    44178,
    44326,
    44474,
    44622,
    44769,
    44915,
    45062,
    45207,
    45353,
    45498,
    45642,
    45786,
    45930,
    46073,
    46216,
    46358,
    46500,
    46642,
    46783,
    46923,
    47063,
    47203,
    47342,
    47481,
    47619,
    47757,
    47895,
    48032,
    48168,
    48305,
    48440,
    48575,
    48710,
    48844,
    48978,
    49112,
    49244,
    49377,
    49509,
    49640,
    49771,
    49902,
    50032,
    50162,
    50291,
    50420,
    50548,
    50675,
    50803,
    50929,
    51056,
    51182,
    51307,
    51432,
    51556,
    51680,
    51803,
    51926,
    52049,
    52171,
    52292,
    52413,
    52534,
    52653,
    52773,
    52892,
    53010,
    53128,
    53246,
    53363,
    53479,
    53595,
    53711,
    53826,
    53940,
    54054,
    54167,
    54280,
    54393,
    54505,
    54616,
    54727,
    54837,
    54947,
    55056,
    55165,
    55274,
    55381,
    55489,
    55595,
    55701,
    55807,
    55912,
    56017,
    56121,
    56225,
    56328,
    56430,
    56532,
    56633,
    56734,
    56835,
    56935,
    57034,
    57133,
    57231,
    57329,
    57426,
    57522,
    57618,
    57714,
    57809,
    57903,
    57997,
    58091,
    58183,
    58276,
    58367,
    58459,
    58549,
    58639,
    58729,
    58818,
    58906,
    58994,
    59081,
    59168,
    59254,
    59340,
    59425,
    59509,
    59593,
    59677,
    59759,
    59842,
    59923,
    60004,
    60085,
    60165,
    60244,
    60323,
    60402,
    60479,
    60556,
    60633,
    60709,
    60785,
    60859,
    60934,
    61007,
    61081,
    61153,
    61225,
    61297,
    61367,
    61438,
    61507,
    61577,
    61645,
    61713,
    61780,
    61847,
    61913,
    61979,
    62044,
    62108,
    62172,
    62236,
    62298,
    62360,
    62422,
    62483,
    62543,
    62603,
    62662,
    62721,
    62779,
    62836,
    62893,
    62949,
    63005,
    63060,
    63114,
    63168,
    63221,
    63274,
    63326,
    63378,
    63429,
    63479,
    63528,
    63578,
    63626,
    63674,
    63721,
    63768,
    63814,
    63859,
    63904,
    63949,
    63992,
    64035,
    64078,
    64120,
    64161,
    64202,
    64242,
    64281,
    64320,
    64358,
    64396,
    64433,
    64469,
    64505,
    64540,
    64575,
    64609,
    64642,
    64675,
    64707,
    64739,
    64770,
    64800,
    64830,
    64859,
    64887,
    64915,
    64943,
    64969,
    64995,
    65021,
    65046,
    65070,
    65094,
    65117,
    65139,
    65161,
    65182,
    65202,
    65222,
    65242,
    65260,
    65279,
    65296,
    65313,
    65329,
    65345,
    65360,
    65374,
    65388,
    65401,
    65414,
    65426,
    65437,
    65448,
    65458,
    65467,
    65476,
    65484,
    65492,
    65499,
    65505,
    65511,
    65516,
    65521,
    65525,
    65528,
    65531,
    65533,
    65534,
    65535,
]

FINESINE_DELTAS = [
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    151,
    50,
    100,
    224,
    50,
    100,
    150,
    50,
    100,
    150,
    51,
    101,
    151,
    51,
    101,
    151,
    50,
    225,
    151,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    101,
    151,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    151,
    50,
    100,
    150,
    50,
    100,
    151,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    226,
    151,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    50,
    100,
    150,
    49,
    99,
    149,
    50,
    100,
    150,
    50,
    100,
    149,
    50,
    100,
    150,
    50,
    99,
    149,
    50,
    100,
    149,
    50,
    100,
    150,
    50,
    100,
    150,
    49,
    99,
    149,
    49,
    99,
    149,
    50,
    100,
    150,
    50,
    100,
    149,
    50,
    99,
    149,
    49,
    99,
    149,
    50,
    99,
    149,
    49,
    99,
    148,
    50,
    99,
    149,
    50,
    99,
    149,
    50,
    99,
    149,
    50,
    99,
    149,
    50,
    99,
    149,
    50,
    99,
    148,
    49,
    99,
    148,
    227,
    49,
    98,
    148,
    49,
    99,
    148,
    50,
    99,
    148,
    49,
    98,
    147,
    49,
    98,
    147,
    49,
    98,
    147,
    49,
    98,
    147,
    228,
    99,
    148,
    49,
    98,
    147,
    50,
    99,
    148,
    49,
    98,
    147,
    49,
    98,
    147,
    49,
    98,
    147,
    49,
    98,
    147,
    49,
    98,
    147,
    48,
    97,
    146,
    49,
    98,
    147,
    49,
    98,
    147,
    49,
    97,
    146,
    49,
    97,
    146,
    48,
    97,
    146,
    48,
    97,
    146,
    49,
    97,
    146,
    48,
    97,
    145,
    49,
    97,
    146,
    49,
    97,
    146,
    49,
    97,
    146,
    48,
    97,
    145,
    48,
    96,
    145,
    49,
    97,
    145,
    48,
    96,
    144,
    48,
    96,
    144,
    48,
    96,
    144,
    48,
    96,
    144,
    48,
    96,
    145,
    48,
    96,
    144,
    48,
    96,
    144,
    48,
    96,
    144,
    48,
    96,
    144,
    48,
    96,
    143,
    48,
    96,
    144,
    47,
    95,
    143,
    48,
    95,
    143,
    48,
    95,
    143,
    47,
    95,
    143,
    48,
    95,
    143,
    47,
    95,
    142,
    47,
    95,
    142,
    47,
    95,
    142,
    47,
    94,
    142,
    48,
    95,
    142,
    47,
    94,
    141,
    47,
    94,
    229,
    47,
    94,
    141,
    48,
    95,
    142,
    47,
    94,
    141,
    47,
    94,
    141,
    47,
    94,
    141,
    47,
    94,
    141,
    47,
    94,
    141,
    47,
    94,
    141,
    46,
    93,
    140,
    46,
    93,
    140,
    47,
    94,
    140,
    47,
    93,
    140,
    47,
    93,
    140,
    47,
    93,
    140,
    47,
    93,
    139,
    46,
    93,
    139,
    47,
    93,
    139,
    47,
    93,
    139,
    46,
    93,
    139,
    46,
    92,
    138,
    46,
    92,
    138,
    46,
    92,
    138,
    46,
    92,
    138,
    46,
    92,
    138,
    46,
    92,
    138,
    45,
    91,
    137,
    46,
    92,
    137,
    46,
    91,
    137,
    46,
    92,
    137,
    45,
    91,
    136,
    46,
    91,
    137,
    45,
    91,
    136,
    46,
    91,
    136,
    46,
    91,
    136,
    45,
    91,
    136,
    45,
    90,
    135,
    45,
    90,
    135,
    45,
    90,
    135,
    45,
    89,
    134,
    45,
    90,
    134,
    45,
    90,
    134,
    45,
    89,
    134,
    44,
    89,
    133,
    230,
    89,
    231,
    44,
    89,
    133,
    44,
    88,
    133,
    44,
    89,
    133,
    44,
    89,
    133,
    44,
    88,
    133,
    44,
    88,
    132,
    44,
    88,
    132,
    44,
    88,
    132,
    43,
    87,
    131,
    44,
    87,
    131,
    44,
    87,
    131,
    43,
    87,
    131,
    44,
    87,
    131,
    44,
    87,
    131,
    44,
    87,
    130,
    43,
    86,
    130,
    43,
    86,
    130,
    43,
    86,
    129,
    43,
    86,
    130,
    43,
    86,
    129,
    43,
    86,
    129,
    43,
    86,
    129,
    43,
    86,
    129,
    43,
    86,
    128,
    43,
    85,
    128,
    43,
    85,
    128,
    43,
    85,
    128,
    42,
    85,
    127,
    43,
    85,
    127,
    43,
    85,
    127,
    42,
    84,
    126,
    42,
    84,
    126,
    42,
    84,
    126,
    42,
    84,
    125,
    42,
    84,
    232,
    42,
    84,
    125,
    41,
    83,
    125,
    42,
    83,
    125,
    41,
    83,
    124,
    41,
    82,
    124,
    41,
    82,
    233,
    41,
    82,
    123,
    41,
    82,
    123,
    41,
    82,
    123,
    41,
    82,
    123,
    40,
    81,
    122,
    40,
    81,
    122,
    41,
    82,
    122,
    40,
    81,
    121,
    40,
    81,
    121,
    41,
    81,
    121,
    40,
    80,
    120,
    40,
    80,
    120,
    40,
    80,
    120,
    40,
    80,
    120,
    40,
    80,
    120,
    40,
    80,
    120,
    40,
    80,
    234,
    40,
    79,
    119,
    40,
    79,
    119,
    40,
    79,
    118,
    39,
    78,
    118,
    39,
    78,
    235,
    39,
    78,
    117,
    39,
    78,
    117,
    39,
    78,
    117,
    38,
    77,
    116,
    38,
    77,
    116,
    39,
    78,
    116,
    38,
    77,
    115,
    38,
    77,
    115,
    39,
    77,
    115,
    38,
    76,
    114,
    39,
    77,
    115,
    38,
    76,
    114,
    38,
    76,
    114,
    38,
    76,
    114,
    37,
    75,
    113,
    38,
    76,
    113,
    37,
    75,
    112,
    37,
    75,
    112,
    38,
    75,
    112,
    38,
    75,
    112,
    37,
    74,
    111,
    37,
    74,
    111,
    37,
    74,
    111,
    37,
    73,
    110,
    37,
    73,
    110,
    37,
    74,
    110,
    36,
    73,
    109,
    37,
    73,
    109,
    36,
    72,
    109,
    36,
    72,
    108,
    36,
    72,
    108,
    36,
    72,
    108,
    36,
    72,
    107,
    36,
    72,
    107,
    236,
    71,
    107,
    36,
    71,
    107,
    36,
    71,
    106,
    35,
    70,
    105,
    35,
    70,
    105,
    35,
    70,
    105,
    35,
    70,
    105,
    35,
    70,
    237,
    35,
    70,
    104,
    35,
    69,
    104,
    35,
    69,
    104,
    35,
    69,
    238,
    34,
    68,
    103,
    34,
    68,
    102,
    34,
    239,
    103,
    240,
    33,
    67,
    101,
    34,
    68,
    102,
    34,
    68,
    101,
    34,
    67,
    101,
    34,
    67,
    101,
    34,
    67,
    100,
    33,
    66,
    99,
    34,
    67,
    100,
    33,
    66,
    99,
    33,
    66,
    99,
    33,
    66,
    99,
    33,
    66,
    98,
    33,
    65,
    98,
    241,
    65,
    97,
    32,
    64,
    97,
    32,
    64,
    96,
    32,
    64,
    96,
    32,
    64,
    96,
    32,
    64,
    96,
    31,
    63,
    95,
    32,
    64,
    95,
    31,
    63,
    94,
    31,
    62,
    94,
    31,
    62,
    94,
    31,
    62,
    93,
    31,
    62,
    93,
    31,
    62,
    93,
    31,
    62,
    93,
    31,
    62,
    92,
    30,
    61,
    91,
    30,
    60,
    91,
    30,
    61,
    91,
    30,
    60,
    90,
    30,
    60,
    90,
    30,
    60,
    90,
    30,
    59,
    89,
    30,
    59,
    89,
    30,
    59,
    89,
    30,
    59,
    88,
    29,
    58,
    88,
    29,
    58,
    87,
    29,
    58,
    87,
    29,
    58,
    87,
    28,
    57,
    86,
    28,
    57,
    242,
    29,
    57,
    86,
    28,
    57,
    85,
    29,
    57,
    85,
    243,
    57,
    85,
    28,
    56,
    84,
    28,
    55,
    83,
    28,
    56,
    83,
    28,
    55,
    83,
    28,
    55,
    83,
    27,
    55,
    82,
    28,
    55,
    82,
    27,
    54,
    81,
    26,
    53,
    80,
    27,
    54,
    81,
    26,
    53,
    80,
    27,
    53,
    80,
    27,
    53,
    80,
    26,
    53,
    79,
    26,
    53,
    79,
    26,
    52,
    78,
    26,
    52,
    78,
    25,
    51,
    77,
    25,
    51,
    76,
    26,
    51,
    77,
    25,
    51,
    76,
    26,
    51,
    76,
    26,
    51,
    76,
    25,
    50,
    75,
    24,
    49,
    74,
    25,
    49,
    74,
    24,
    49,
    73,
    24,
    49,
    73,
    24,
    48,
    73,
    24,
    48,
    72,
    24,
    48,
    72,
    24,
    48,
    72,
    24,
    48,
    71,
    24,
    47,
    71,
    24,
    47,
    71,
    24,
    47,
    70,
    23,
    46,
    69,
    24,
    47,
    70,
    23,
    46,
    69,
    23,
    46,
    69,
    22,
    45,
    68,
    23,
    45,
    68,
    23,
    45,
    67,
    22,
    44,
    66,
    22,
    44,
    66,
    22,
    44,
    66,
    22,
    44,
    65,
    22,
    44,
    65,
    244,
    43,
    65,
    22,
    43,
    64,
    21,
    42,
    64,
    21,
    42,
    63,
    21,
    42,
    63,
    21,
    42,
    63,
    20,
    41,
    62,
    21,
    42,
    62,
    20,
    41,
    61,
    21,
    41,
    61,
    21,
    41,
    61,
    20,
    40,
    60,
    20,
    40,
    60,
    20,
    40,
    60,
    20,
    40,
    59,
    19,
    39,
    58,
    20,
    39,
    58,
    20,
    39,
    58,
    19,
    38,
    57,
    19,
    38,
    57,
    18,
    37,
    56,
    19,
    38,
    56,
    18,
    37,
    55,
    19,
    37,
    55,
    18,
    36,
    54,
    18,
    36,
    54,
    18,
    36,
    54,
    17,
    35,
    53,
    18,
    36,
    53,
    17,
    35,
    52,
    18,
    35,
    52,
    17,
    34,
    51,
    17,
    34,
    51,
    17,
    34,
    51,
    17,
    34,
    51,
    17,
    33,
    50,
    17,
    33,
    50,
    16,
    33,
    49,
    16,
    32,
    48,
    17,
    33,
    48,
    16,
    32,
    48,
    15,
    31,
    47,
    16,
    31,
    47,
    16,
    31,
    47,
    15,
    31,
    46,
    15,
    30,
    45,
    15,
    30,
    45,
    15,
    30,
    45,
    15,
    30,
    44,
    14,
    29,
    43,
    14,
    29,
    43,
    14,
    29,
    43,
    14,
    28,
    42,
    14,
    28,
    42,
    14,
    27,
    41,
    14,
    27,
    41,
    14,
    27,
    41,
    14,
    27,
    40,
    14,
    27,
    40,
    13,
    26,
    39,
    13,
    26,
    39,
    12,
    25,
    38,
    12,
    25,
    37,
    12,
    25,
    37,
    13,
    25,
    37,
    12,
    24,
    36,
    12,
    24,
    36,
    12,
    24,
    35,
    12,
    24,
    35,
    11,
    23,
    35,
    11,
    23,
    34,
    12,
    23,
    34,
    11,
    23,
    34,
    11,
    22,
    32,
    11,
    22,
    33,
    11,
    22,
    32,
    10,
    21,
    31,
    10,
    20,
    31,
    10,
    20,
    31,
    10,
    20,
    30,
    10,
    19,
    29,
    10,
    20,
    29,
    10,
    19,
    29,
    10,
    19,
    29,
    9,
    18,
    28,
    9,
    18,
    27,
    9,
    18,
    27,
    9,
    18,
    27,
    9,
    18,
    26,
    9,
    17,
    245,
    8,
    17,
    25,
    9,
    17,
    25,
    8,
    16,
    24,
    8,
    16,
    24,
    8,
    15,
    23,
    7,
    15,
    23,
    8,
    15,
    22,
    7,
    14,
    22,
    7,
    14,
    21,
    8,
    15,
    21,
    7,
    14,
    21,
    6,
    13,
    20,
    7,
    13,
    20,
    7,
    13,
    20,
    6,
    12,
    19,
    6,
    12,
    18,
    6,
    12,
    18,
    5,
    11,
    17,
    5,
    11,
    16,
    5,
    11,
    16,
    5,
    10,
    16,
    5,
    10,
    15,
    5,
    10,
    15,
    5,
    10,
    15,
    4,
    9,
    14,
    5,
    10,
    14,
    4,
    8,
    13,
    4,
    9,
    13,
    4,
    8,
    12,
    4,
    8,
    12,
    4,
    7,
    11,
    3,
    7,
    11,
    4,
    7,
    11,
    3,
    7,
    10,
    3,
    7,
    10,
    3,
    6,
    9,
    3,
    5,
    8,
    3,
    5,
    8,
    2,
    5,
    7,
    2,
    5,
    7,
    3,
    5,
    7,
    2,
    4,
    6,
    2,
    4,
    6,
    2,
    4,
    5,
    2,
    3,
    5,
    2,
    3,
    5,
    2,
    3,
    4,
    2,
    3,
    4,
    1,
    2,
    3,
    1,
    2,
    2,
    1,
    2,
    2,
    0,
    1,
    1,
    0,
    1,
    1,
    1,
    1,
    1,
    0,
    0,
    0,
]

FINESINE_EXCEPTIONS = [
    5270,
    612,
    2405,
    2048,
    16434,
    2446,
    556,
    645,
    34429,
    2172,
    10616,
    32885,
    2084,
    2153,
    615,
    8261,
    24576,
    289,
    597,
    540,
    2070,
    16666,
]

TANTOANGLE_ANCHORS = [
    0,
    10679838,
    21354466,
    32018684,
    42667332,
    53295284,
    63897480,
    74468936,
    85004760,
    95500136,
    105950392,
    116350960,
    126697424,
    136985488,
    147211040,
    157370112,
    167458912,
    177473792,
    187411344,
    197268304,
    207041584,
    216728304,
    226325776,
    235831504,
    245243168,
    254558640,
    263776000,
    272893440,
    281909472,
    290822592,
    299631648,
    308335552,
    316933408,
    325424448,
    333808128,
    342083968,
    350251648,
    358311008,
    366261952,
    374104608,
    381839104,
    389465728,
    396984864,
    404397024,
    411702720,
    418902624,
    425997408,
    432987936,
    439875008,
    446659552,
    453342528,
    459924960,
    466407904,
    472792448,
    479079744,
    485270944,
    491367232,
    497369856,
    503280000,
    509099008,
    514828064,
    520468480,
    526021568,
    531488608,
    536870912,
]

TANTOANGLE_AVG_DELTAS = [
    333746,
    333586,
    333263,
    332779,
    332135,
    331332,
    330374,
    329263,
    328001,
    326594,
    325043,
    323354,
    321531,
    319580,
    317505,
    315310,
    313002,
    310587,
    308070,
    305456,
    302753,
    299965,
    297099,
    294161,
    291156,
    288090,
    284969,
    281800,
    278585,
    275334,
    272048,
    268734,
    265397,
    262042,
    258672,
    255292,
    251907,
    248520,
    245135,
    241755,
    238384,
    235025,
    231682,
    228355,
    225047,
    221763,
    218504,
    215271,
    212067,
    208892,
    205749,
    202640,
    199564,
    196524,
    193521,
    190554,
    187627,
    184737,
    181888,
    179076,
    176306,
    173576,
    170887,
    168238,
    0,
]

TANTOANGLE_OFFSETS = [
    26,
    52,
    77,
    102,
    127,
    150,
    173,
    195,
    215,
    234,
    251,
    267,
    281,
    292,
    302,
    309,
    313,
    315,
    314,
    310,
    302,
    292,
    277,
    260,
    238,
    213,
    183,
    149,
    110,
    67,
    19,
    102,
    # ... (truncated for brevity - full array in tables.h)
]


# =============================================================================
# Decompression functions (matching C logic exactly)
# =============================================================================


def finetangent_half(idx):
    """Decompress finetangent for idx in [0, 2048)"""
    if idx < 256:
        shift = 1
        region_start = 0
        base_anchors = 0
        base_offsets = 0
    elif idx < 1024:
        shift = 3
        region_start = 256
        base_anchors = 128
        base_offsets = 128
    else:
        shift = 5
        region_start = 1024
        base_anchors = 224
        base_offsets = 800

    local_idx = idx - region_start
    anchor_idx = base_anchors + (local_idx >> shift)
    pos = local_idx - ((local_idx >> shift) << shift)

    if pos == 0:
        return FINETANGENT_ANCHORS[anchor_idx]

    compressed_idx = base_offsets + local_idx - (local_idx >> shift) - 1
    result = FINETANGENT_ANCHORS[anchor_idx]
    result += FINETANGENT_AVG_DELTAS[anchor_idx] * pos
    result += FINETANGENT_OFFSETS[compressed_idx]
    return result


def finetangent(idx):
    """Get finetangent value for idx in [0, 4096)"""
    if idx < 2048:
        return finetangent_half(idx)
    else:
        return -finetangent_half(4095 - idx)


def finesine_quarter(q_idx):
    """Get finesine value for q_idx in [0, 2048) - Q1 only, no corrections"""
    anchor_idx = q_idx >> 2
    anchor_value = FINESINE_ANCHORS[anchor_idx]

    # At anchor position (not exception)
    if (q_idx & 0x03) == 0 and q_idx != 244 and q_idx != 1080:
        return anchor_value

    # Compute compressed index
    num_kept_before = 0
    if 244 < q_idx:
        num_kept_before += 1
    if 1080 < q_idx:
        num_kept_before += 1

    compressed_idx = q_idx - (((q_idx + 3) >> 2) - num_kept_before)
    delta = FINESINE_DELTAS[compressed_idx] & 0xFFFF

    # Normal delta (not exception marker)
    if (delta & 0xE0) != 0xE0:
        return anchor_value + delta

    # Exception - get true delta
    exc_idx = delta & 0x1F
    exc_packed = FINESINE_EXCEPTIONS[exc_idx] & 0xFFFF
    true_delta = exc_packed & 0xFF
    return anchor_value + true_delta


def finesine(idx):
    """Get finesine value for idx in [0, 8192)"""
    quarter = 2048
    if idx < quarter:
        return finesine_quarter(idx)
    elif idx < 2 * quarter:
        q_idx = 2047 - (idx - quarter)
        return finesine_quarter(q_idx)
    elif idx < 3 * quarter:
        q_idx = idx - 2 * quarter
        return -finesine_quarter(q_idx)
    else:
        q_idx = 2047 - (idx - 3 * quarter)
        return -finesine_quarter(q_idx)


def tantoangle(idx):
    """Get tantoangle value for idx in [0, 2048].

    Computes mathematically: atan(idx / 2048) scaled to BAM angle space.
    tantoangle[2048] = ANG45 = 0x20000000 = 536870912
    """
    # Mathematical computation: atan(idx/2048) * (ANG90 / (pi/2))
    # ANG90 = 0x40000000 = 1073741824
    # So scale factor = ANG90 / (pi/2) = 1073741824 / 1.5707963... = 683565275.58
    import math

    if idx == 0:
        return 0
    angle_rad = math.atan(idx / 2048.0)
    # Scale to BAM: full circle = 2^32, so ANG90 = 2^30
    ANG90 = 0x40000000
    return int(angle_rad * ANG90 / (math.pi / 2))


# =============================================================================
# Generate reduced tables (1/4 size)
# =============================================================================


def compress_with_anchors(values, anchor_spacing):
    """Compress values using anchor + delta scheme."""
    anchors = []
    deltas = []

    for i in range(0, len(values), anchor_spacing):
        anchors.append(values[i])

    for i, v in enumerate(values):
        if i % anchor_spacing != 0:
            anchor_idx = i // anchor_spacing
            delta = v - anchors[anchor_idx]
            deltas.append(delta)

    return anchors, deltas


def compress_with_avg_deltas(values, anchor_spacing):
    """Compress values using anchor + avg_delta*pos + offset scheme."""
    anchors = []
    avg_deltas = []
    offsets = []

    n_segments = (len(values) + anchor_spacing - 1) // anchor_spacing

    for seg in range(n_segments):
        start = seg * anchor_spacing
        end = min(start + anchor_spacing, len(values))
        anchors.append(values[start])

        # Compute average delta for this segment
        if end > start + 1:
            total_delta = values[end - 1] - values[start] if end == start + anchor_spacing else 0
            avg_delta = total_delta // (anchor_spacing - 1) if anchor_spacing > 1 else 0
        else:
            avg_delta = 0
        avg_deltas.append(avg_delta)

        # Compute offsets
        for pos in range(1, end - start):
            expected = values[start] + avg_delta * pos
            actual = values[start + pos]
            offsets.append(actual - expected)

    return anchors, avg_deltas, offsets


def generate_reduced_finesine():
    """Generate reduced FINESINE tables (512 entries from 2048)."""
    # Sample every 4th value from Q1
    reduced_values = [finesine_quarter(i * 4) for i in range(512)]

    # Compress with anchors every 4 positions = 128 anchors
    anchors, deltas = compress_with_anchors(reduced_values, 4)

    return anchors, deltas


def generate_reduced_finetangent():
    """Generate reduced FINETANGENT tables (512 entries from 2048)."""
    # Sample every 4th value from half table
    reduced_values = [finetangent_half(i * 4) for i in range(512)]

    # Variable-frequency regions scaled by 1/4:
    # Region 1 [0-64): every 2 -> 32 anchors, 32 offsets
    # Region 2 [64-256): every 8 -> 24 anchors, 168 offsets
    # Region 3 [256-512): every 32 -> 8 anchors, 248 offsets

    anchors = []
    avg_deltas = []
    offsets = []

    # Region 1: [0-64), anchor every 2
    for i in range(0, 64, 2):
        anchors.append(reduced_values[i])
        if i + 1 < 64:
            avg_deltas.append(reduced_values[i + 1] - reduced_values[i])
        else:
            avg_deltas.append(0)
    for i in range(1, 64, 2):
        # offset = actual - (anchor + avg_delta * 1) = actual - next value prediction
        # But with spacing 2, pos is always 1, and offset = actual - anchor - avg_delta
        # Actually for spacing 2: offset[i] = value[i] - anchor - avg_delta * 1
        # which is just 0 if avg_delta = value[i] - anchor
        offsets.append(0)  # With exact avg_delta, offset is 0

    # Region 2: [64-256), anchor every 8
    for seg_start in range(64, 256, 8):
        anchors.append(reduced_values[seg_start])
        seg_end = min(seg_start + 8, 256)
        if seg_end > seg_start + 1:
            total_span = reduced_values[seg_end - 1] - reduced_values[seg_start]
            avg_delta = total_span // 7  # 7 intervals in 8 values
        else:
            avg_delta = 0
        avg_deltas.append(avg_delta)

        for pos in range(1, seg_end - seg_start):
            expected = reduced_values[seg_start] + avg_delta * pos
            actual = reduced_values[seg_start + pos]
            offsets.append(actual - expected)

    # Region 3: [256-512), anchor every 32
    for seg_start in range(256, 512, 32):
        anchors.append(reduced_values[seg_start])
        seg_end = min(seg_start + 32, 512)
        if seg_end > seg_start + 1:
            total_span = reduced_values[seg_end - 1] - reduced_values[seg_start]
            avg_delta = total_span // 31  # 31 intervals in 32 values
        else:
            avg_delta = 0
        avg_deltas.append(avg_delta)

        for pos in range(1, seg_end - seg_start):
            expected = reduced_values[seg_start] + avg_delta * pos
            actual = reduced_values[seg_start + pos]
            offsets.append(actual - expected)

    return anchors, avg_deltas, offsets


def generate_reduced_tantoangle():
    """Generate reduced TANTOANGLE tables (512 entries from 2048)."""
    # Sample every 4th value
    reduced_values = [tantoangle(i * 4) for i in range(513)]  # Include endpoint

    # 512 entries in 32-element segments = 16 segments = 17 anchors
    anchors, avg_deltas, offsets = compress_with_avg_deltas(reduced_values, 32)

    return anchors, avg_deltas, offsets


def format_array(name, values, type_name, per_line=8):
    """Format array as C code."""
    lines = [f"const {type_name} {name}[] = {{"]

    for i in range(0, len(values), per_line):
        chunk = values[i : i + per_line]
        line = "    " + ", ".join(str(v) for v in chunk) + ","
        lines.append(line)

    lines.append("};")
    return "\n".join(lines)


def replace_array_in_file(content, array_name, new_values, type_name, per_line=8):
    """Replace an array definition in file content."""
    import re

    # Pattern to match: const TYPE NAME[] = { ... };
    pattern = rf"(const\s+{type_name}\s+{array_name}\s*\[\s*\]\s*=\s*\{{)[^}}]*(}}\s*;)"

    # Format the new array body
    lines = []
    for i in range(0, len(new_values), per_line):
        chunk = new_values[i : i + per_line]
        line = "    " + ", ".join(str(v) for v in chunk) + ","
        lines.append(line)
    new_body = "\n" + "\n".join(lines) + "\n"

    replacement = rf"\1{new_body}\2"
    new_content, count = re.subn(pattern, replacement, content, flags=re.DOTALL)

    if count == 0:
        print(f"WARNING: Could not find array {array_name} to replace")
    else:
        print(f"  Replaced {array_name}: {len(new_values)} elements")

    return new_content


def update_tables_h(tables_path):
    """Update tables.h with reduced tables in-place."""
    import os

    print(f"Updating {tables_path}...")

    with open(tables_path, "r") as f:
        content = f.read()

    # Generate reduced tables
    sine_anchors, sine_deltas = generate_reduced_finesine()
    tan_anchors, tan_avg_deltas, tan_offsets = generate_reduced_finetangent()
    tta_anchors, tta_avg_deltas, tta_offsets = generate_reduced_tantoangle()

    # Replace FINETANGENT arrays
    content = replace_array_in_file(content, "FINETANGENT_ANCHORS", tan_anchors, "int")
    content = replace_array_in_file(content, "FINETANGENT_AVG_DELTAS", tan_avg_deltas, "int")
    content = replace_array_in_file(content, "FINETANGENT_OFFSETS", tan_offsets, "byte", per_line=16)

    # Replace FINESINE arrays
    content = replace_array_in_file(content, "FINESINE_ANCHORS", sine_anchors, "int")
    content = replace_array_in_file(content, "FINESINE_DELTAS", sine_deltas, "short", per_line=8)

    # Remove FINESINE_EXCEPTIONS array entirely
    import re

    content = re.sub(
        r"// JDOOM: TableData\.java:380-384.*?const short FINESINE_EXCEPTIONS\[\] = \{[^}]*\};",
        "// FINESINE_EXCEPTIONS removed - not needed for reduced tables",
        content,
        flags=re.DOTALL,
    )

    # Replace TANTOANGLE arrays
    content = replace_array_in_file(content, "TANTOANGLE_ANCHORS", tta_anchors, "int")
    content = replace_array_in_file(content, "TANTOANGLE_AVG_DELTAS", tta_avg_deltas, "int")
    content = replace_array_in_file(content, "TANTOANGLE_OFFSETS", tta_offsets, "short", per_line=8)

    # Update header comments
    content = re.sub(
        r"// Compression: 65,540 -> \d+,?\d* bytes.*", f"// Reduced tables: ~3,400 bytes (was ~12,000 bytes)", content
    )
    content = re.sub(
        r"// Storage: 256 anchors \+ 256 avg_deltas \+ 1792 offsets.*",
        f"// Storage: {len(tan_anchors)} anchors + {len(tan_avg_deltas)} avg_deltas + {len(tan_offsets)} offsets = {len(tan_anchors) * 4 + len(tan_avg_deltas) * 4 + len(tan_offsets)} bytes",
        content,
    )
    content = re.sub(
        r"// Storage: 512 anchors \+ 1538 deltas \+ 22 exceptions",
        f"// Storage: {len(sine_anchors)} anchors + {len(sine_deltas)} deltas = {len(sine_anchors) * 4 + len(sine_deltas) * 2} bytes",
        content,
    )
    content = re.sub(
        r"// Storage: 65 anchors \+ 65 avg_deltas \+ 1984 offsets",
        f"// Storage: {len(tta_anchors)} anchors + {len(tta_avg_deltas)} avg_deltas + {len(tta_offsets)} offsets = {len(tta_anchors) * 4 + len(tta_avg_deltas) * 4 + len(tta_offsets) * 2} bytes",
        content,
    )

    with open(tables_path, "w") as f:
        f.write(content)

    print(f"\nSummary:")
    print(f"  FINESINE: {len(sine_anchors) * 4 + len(sine_deltas) * 2} bytes")
    print(f"  FINETANGENT: {len(tan_anchors) * 4 + len(tan_avg_deltas) * 4 + len(tan_offsets)} bytes")
    print(f"  TANTOANGLE: {len(tta_anchors) * 4 + len(tta_avg_deltas) * 4 + len(tta_offsets) * 2} bytes")
    total = (
        len(sine_anchors) * 4
        + len(sine_deltas) * 2
        + len(tan_anchors) * 4
        + len(tan_avg_deltas) * 4
        + len(tan_offsets)
        + len(tta_anchors) * 4
        + len(tta_avg_deltas) * 4
        + len(tta_offsets) * 2
    )
    print(f"  TOTAL: {total} bytes")


def main():
    import sys
    import os

    # Find tables.h relative to this script
    script_dir = os.path.dirname(os.path.abspath(__file__))
    tables_path = os.path.join(script_dir, "..", "data", "tables.h")
    tables_path = os.path.normpath(tables_path)

    if len(sys.argv) > 1 and sys.argv[1] == "--print":
        # Just print the tables (old behavior)
        print("// Reduced trig tables (1/4 size)")
        print("// Generated by generate_reduced_tables.py")
        print()

        sine_anchors, sine_deltas = generate_reduced_finesine()
        print(
            f"// FINESINE: {len(sine_anchors)} anchors + {len(sine_deltas)} deltas = {len(sine_anchors) * 4 + len(sine_deltas) * 2} bytes"
        )
        print(format_array("FINESINE_ANCHORS", sine_anchors, "int"))
        print(format_array("FINESINE_DELTAS", sine_deltas, "short"))

        tan_anchors, tan_avg_deltas, tan_offsets = generate_reduced_finetangent()
        print(
            f"// FINETANGENT: {len(tan_anchors)} anchors + {len(tan_avg_deltas)} avg_deltas + {len(tan_offsets)} offsets = {len(tan_anchors) * 4 + len(tan_avg_deltas) * 4 + len(tan_offsets)} bytes"
        )
        print(format_array("FINETANGENT_ANCHORS", tan_anchors, "int"))
        print(format_array("FINETANGENT_AVG_DELTAS", tan_avg_deltas, "int"))
        print(format_array("FINETANGENT_OFFSETS", tan_offsets, "byte", per_line=16))

        tta_anchors, tta_avg_deltas, tta_offsets = generate_reduced_tantoangle()
        print(
            f"// TANTOANGLE: {len(tta_anchors)} anchors + {len(tta_avg_deltas)} avg_deltas + {len(tta_offsets)} offsets = {len(tta_anchors) * 4 + len(tta_avg_deltas) * 4 + len(tta_offsets) * 2} bytes"
        )
        print(format_array("TANTOANGLE_ANCHORS", tta_anchors, "int"))
        print(format_array("TANTOANGLE_AVG_DELTAS", tta_avg_deltas, "int"))
        print(format_array("TANTOANGLE_OFFSETS", tta_offsets, "short"))
    else:
        # Update tables.h in-place
        update_tables_h(tables_path)


if __name__ == "__main__":
    main()
